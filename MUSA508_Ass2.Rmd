---
title: "Transit Oriented Development in Washington DC"
author: "Ling Chenr"
date: "2023-09-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load package, warning = FALSE, message = FALSE} 
library(tidycensus)
library(tidyverse)
library(ggplot2)
library(sf)
library(kableExtra)

options(scipen=999)
options(tigris_class = "sf")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac")
```

```{r}
newqBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],4),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                                  c(.01,.2,.4,.6,.8), na.rm=T),
                         digits = 3))
  }
}
```

## Load census data dictionaries


```{r load_variables, cache = TRUE}

acs_variable_list.2019 <- load_variables(2019, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)

acs_variable_list.2009 <- load_variables(2009, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)
```

### Use `get_acs()` to get 2019 ACS data

Notice this returns "long" data - let's examine it

```{r results='hide'}
tracts19 <-  
  get_acs(geography = "tract",
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E", "B25058_001E",
                        "B06012_002E"), 
          year=2019, state=11,
          geometry=TRUE) %>% 
  st_transform('ESRI:102728')
```

```{r}
glimpse(tracts19)
```

We create a new data frame consisting only of population

```{r}

totalPop19 <-
  tracts19 %>%
  filter(variable == "B25026_001")
```

Ways to examine the data

```{r}
nrow(totalPop19)

names(totalPop19)

head(totalPop19)

glimpse(totalPop19)
```

```{r}
A <- 
  ggplot() +
  geom_sf(data = totalPop19, aes(fill = estimate)) +
  theme(
    plot.title = element_text(size=22)
    )

B <- 
  ggplot() +
  geom_sf(data = totalPop19, aes(fill = q5(estimate))) +
  theme(plot.title = element_text(size=22)) 

C <-
  ggplot() +
  geom_sf(data = totalPop19, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop19, "estimate"),
                    name = "Total\nPopluation\n(Quintile Breaks)") +
  theme(plot.title = element_text(size=22))

D <- 
  ggplot() +
  geom_sf(data = totalPop19, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop19, "estimate"),
                    name = "Popluation\n(Quintile Breaks)") +
  labs(title = "Total Population", subtitle = "Washington DC; 2019") +
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

```{r}
# Let's "spread" the data into wide form

tracts19 <- 
  tracts19 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(key = variable, value = estimate) %>%
  rename(TotalPop = B25026_001, 
         Whites = B02001_002,
         FemaleBachelors = B15001_050, 
         MaleBachelors = B15001_009,
         MedHHInc = B19013_001, 
         MedRent = B25058_001,
         TotalPoverty = B06012_002)


# Let's create new rate variables using mutate

tracts19 <- 
  tracts19 %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop, 0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2019") %>%
  dplyr::select(-Whites,-FemaleBachelors,-MaleBachelors,-TotalPoverty)
```

```{r results='hide'}
tracts09 <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E","B25058_001E",
                        "B06012_002E"), 
          year=2009, state=11, 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102728') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2009") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 
```

```{r}
allTracts <- rbind(tracts19,tracts09)
```

```{r crimedata}
crime19 <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/FEEDS/MPD/MapServer/1/query?outFields=*&where=1%3D1&f=geojson") %>%
  dplyr::select(OFFENSE, CENSUS_TRACT, OBJECTID) %>%
  st_transform('ESRI:102728')  

crime09 <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/FEEDS/MPD/MapServer/33/query?outFields=*&where=1%3D1&f=geojson") %>%
  dplyr::select(OFFENSE, CENSUS_TRACT, OBJECTID) %>%
  st_transform('ESRI:102728') 
  
```
```{r crime_data_09_19}
crime_counts_by_tract_19 <- allTracts %>%
  st_intersection(crime19) %>%
  group_by(GEOID) %>%
  summarise(crime_counts=n()) %>%
  st_drop_geometry() %>%
  mutate(year="2019")


crime_counts_by_tract_09 <- allTracts %>%
  st_intersection(crime09) %>%
  group_by(GEOID) %>%
  summarise(crime_counts=n()) %>%
  st_drop_geometry() %>%
  mutate(year="2009")

```
```{r add_crimedata}
crime_counts_all <- rbind(crime_counts_by_tract_09, crime_counts_by_tract_19)

allTracts <- left_join(allTracts, crime_counts_all, by=c("GEOID"="GEOID", "year"="year"))

```

```{r}
dc_station <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Transportation_Rail_Bus_WebMercator/MapServer/52/query?where=1%3D1&outFields=*&outSR=4326&f=json") %>%
  dplyr::select(NAME,LINE) %>%
  st_transform('ESRI:102728')  

dc_line <- st_read('https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Transportation_Rail_Bus_WebMercator/MapServer/106/query?outFields=*&where=1%3D1&f=geojson') %>%
  dplyr::select(NAME,GIS_ID)%>%
  st_transform('ESRI:102728')
```

```{r}
ggplot() +
  geom_sf(data = st_union(tracts19)) +
  geom_sf(data = dc_station,
          show.legend = 'Point',size=1.5) +
  geom_sf(data = dc_line,
          aes(color = NAME),
          show.legend = 'Line',size=2)+
  labs(title = 'Station Stops',
       subtitle = 'Washington DC',
       caption = 'Figure 2.2')+
  scale_color_manual(values = c("blue","green","orange","red","#C0C0C0","yellow"),name="Metro Line")
```

```{r }
station_buffer<- rbind(
  st_buffer(dc_station,2640) %>%
    mutate(Legend = 'buffer')%>%
    dplyr::select(Legend),
  st_union(st_buffer(dc_station,2640))%>%
    st_sf()%>%
    mutate(Legend = 'Unioned Buffer')
)
```

```{r}
ggplot() +
  geom_sf(data = station_buffer) +
  geom_sf(data = dc_station,
          show.legend = 'Point',size = 2) +
  facet_wrap(~Legend) + 
  labs(caption = 'Figure 2.3')+
  mapTheme()
```

```{r}
buffer <- filter(station_buffer, Legend=='Unioned Buffer')
```

```{r}
clip <- st_intersection(buffer,tracts19) %>%
  dplyr::select(TotalPop)%>%
  mutate(inter_type = 'Clip')
```

```{r}
selection <- tracts19[buffer,]%>%
  select(TotalPop)%>%
  mutate(inter_type = 'Spatial Selection')
```

```{r}
select_centroid <- st_centroid(tracts19)[buffer,] %>%
  st_drop_geometry() %>%
  left_join(., dplyr::select(tracts19, GEOID), by = "GEOID") %>%
  st_sf() %>%
  dplyr::select(TotalPop) %>%
  mutate(inter_type = "Centroids")
```

```{r}
intersections <- rbind(clip, selection, select_centroid)

ggplot() +
  geom_sf(data=intersections, aes(fill = TotalPop)) +
  geom_sf(data=dc_station, show.legend = "point") +
  scale_fill_viridis_c() +
  facet_wrap(~inter_type) + 
  mapTheme()
```

```{r}
allTracts.group <- 
  rbind(
    st_centroid(allTracts)[buffer,] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "TOD"),
    st_centroid(allTracts)[buffer, op = st_disjoint] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "Non-TOD")) %>%
  mutate(MedRent.inf = ifelse(year == "2009", MedRent * 1.19, MedRent)) %>%
  mutate(MedHHInc.inf = ifelse(year == "2009", MedHHInc *1.19, MedHHInc))
```


```{r}
Tod_region <- allTracts.group %>%
  select(TOD) %>%
  filter(TOD =="TOD") %>%
  st_union() %>%
  st_sf()
```

### Trends across space and time
```{r}
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill = TOD))+
  scale_fill_manual(values = c("grey", "yellow"))+
  labs(title = "TOD and Non-TOD Census Tracts in Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()
  
```

```{r}
#Total Population within the TOD & Non-TOD tracts from 2009 to 2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(TotalPop)))+
  geom_sf(data = Tod_region, color = "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= qBr(allTracts.group, "TotalPop"),
                    name = "Population\n(Quintile Breaks)")+
    labs(title = "Total Population by census tracts, 2009-2019",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()

```

```{r}
#Median household income within the TOD & Non-TOD tracts from 2009 to 2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(MedHHInc.inf)))+
  geom_sf(data = Tod_region, color = "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= qBr(allTracts.group, "MedHHInc.inf"),
                    name = "Median Household Income($)\n(Quintile Breaks)\n(Inflation adjusted to 2019)")+
    labs(title = "Median Household Income by census tracts, 2009-2019",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()

```


```{r}
#Percentage of bachelors within the TOD & Non-TOD tracts from 2009 to 2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(pctBachelors)))+
  geom_sf(data = Tod_region, color = "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= newqBr(allTracts.group, "pctBachelors"),
                    name = "Percentage of Bachelors\n(Quintile Breaks)")+
    labs(title = "Percentage of Bachelors by census tracts, 2009-2019",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()

```
```{r}
#Median Rent within the TOD & Non-TOD tracts from 2009 to 2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(MedRent.inf)))+
  geom_sf(data = Tod_region, color = "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= newqBr(allTracts.group, "MedRent.inf"),
                    name = "Median Rent($)\n(Quintile Breaks)\n(Inflation adjusted to 2019)")+
    labs(title = "Median Rent by census tracts, 2009-2019",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()

```

```{r}
#Crime counts within the TOD & Non-TOD tracts from 2009 to 2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(crime_counts)))+
  geom_sf(data = Tod_region, color = "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= newqBr(allTracts.group, "crime_counts"),
                    name = "Crime Counts\n(Quintile Breaks)")+
    labs(title = "Crime Counts by census tracts, 2009-2019",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  facet_wrap(~year)+
  mapTheme()

```

### TOD Indicator Tables

```{r}
allTracts.Summary <- 
  st_drop_geometry(allTracts.group) %>%
  group_by(year, TOD) %>%
  summarize(Rent = mean(MedRent, na.rm = T),
            Population = mean(TotalPop, na.rm = T),
            Percent_White = mean(pctWhite, na.rm = T),
            Percent_Bach = mean(pctBachelors, na.rm = T),
            Percent_Poverty = mean(pctPoverty, na.rm = T))

allTracts.Summary %>%
  unite(year.TOD, year, TOD, sep = ": ", remove = T) %>%
  gather(Variable, Value, -year.TOD) %>%
  mutate(Value = round(Value, 2)) %>%
  spread(year.TOD, Value) %>%
  kable() %>%
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.2")
```

### TOD Indicator Plots

Let's create small multiple plots We use the "gather" command (look this
one up please) To go from wide to long Why do we do this?? Notice we can
"pipe" a ggplot call right into this operation!

```{r}
allTracts.Summary %>%
  gather(Variable, Value, -year, -TOD) %>%
  ggplot(aes(year, Value, fill = TOD)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Variable, scales = "free", ncol=5) +
  scale_fill_manual(values = c("#bae4bc", "#0868ac"),
                    name = "Type") +
  labs(title = "Indicator differences across time and space") +
  plotTheme() + theme(legend.position="bottom")
```

### TOD Indicator Plots

```{r}
centroid_all <- st_centroid(allTracts.group, of_largest_polygon = TRUE)
```

```{r }
# population
ggplot() +
  geom_sf(data = allTracts.group,fill='grey60') + 
  geom_sf(data = centroid_all%>%filter(TOD == 'TOD'),
          pch = 21,
          aes(size=TotalPop),
          fill=alpha('red',0.7),
          col = 'grey20') +
  geom_sf(data = Tod_region, color = "white",fill="transparent", size = 1)+
  facet_wrap(~year) +
  scale_size(range = c(1,4))
```

```{r}
# rent
ggplot() +
  geom_sf(data = allTracts.group,fill='grey60') + 
  geom_sf(data = centroid_all%>%filter(TOD == 'TOD'),
          pch = 21,
          aes(size=MedRent),
          fill=alpha('red',0.7),
          col = 'grey20') +
  geom_sf(data = Tod_region, color = "white",fill="transparent", size = 1)+
  facet_wrap(~year) +
  scale_size(range = c(1,4))
```

```{r create half mile buffers}
station_ring <- multipleRingBuffer(st_union(dc_station), 2640*9, 2640)

allTracts.rings <-
  st_join(st_centroid(dplyr::select(allTracts.group, GEOID, year)),
          station_ring) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(allTracts.group, GEOID, MedRent, year), 
            by=c("GEOID"="GEOID", "year"="year")) %>%
  st_sf() %>%
  mutate(distance = distance / 5280)
```

```{r visualize half mile buffers}
ggplot() +
    geom_sf(data=station_ring,aes(color=distance)) +
  scale_color_gradient()+
    geom_sf(data=dc_station, size=1) +
    geom_sf(data=st_union(allTracts.rings), fill=NA, color="red",size=2) +
    labs(title="Station Stops: Half Mile Buffers",
         subtitle = "Washington DC",
         caption = "Data from US Census Bureau, Open Data DC") +
    mapTheme()
```

#Summarizing Data
```{r Summarize Data}

```

#Distance to subway station 依然有legend bug
```{r Distance to stations}
ggplot(allTracts.rings)+
  geom_sf(data = st_union(tracts19))+
  geom_sf(aes(fill=q5(distance)))+
  geom_sf(data = Tod_region, color= "#de660c",fill="transparent", size = 3)+
  scale_fill_manual(values = palette5,
                    labels= newqBr(allTracts.rings, "distance"),
                    name = "Distance to Subway Stations")+
    labs(title = "Distance to Subway Stations by census tracts",
         subtitle = "Washington DC",
       caption = "Data from US Census Bureau")+
  mapTheme()
```